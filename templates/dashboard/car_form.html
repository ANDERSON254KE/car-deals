{% extends 'base.html' %}

{% block content %}
<div class="max-w-5xl mx-auto mt-12 mb-12">
  <div class="bg-white border border-gray-200 shadow-2xl rounded-2xl p-10">
    <h1 class="text-3xl font-semibold tracking-tight mb-8 text-gray-900 flex items-center">
      {% if view.object %}
        <span class="text-blue-600 mr-3">‚úèÔ∏è</span> Edit Car
      {% else %}
        <span class="text-green-600 mr-3">üöó</span> Add New Car
      {% endif %}
    </h1>

    <!-- DISPLAY FORM ERRORS -->
    {% if form.errors %}
      <div class="mb-6 bg-red-50 border-l-4 border-red-500 p-4 rounded">
        <div class="flex">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-red-800">Please fix the following errors:</h3>
            <div class="mt-2 text-sm text-red-700">
              <ul class="list-disc list-inside space-y-1">
                {% for field, errors in form.errors.items %}
                  {% for error in errors %}
                    <li><strong>{{ field }}:</strong> {{ error }}</li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" class="space-y-8">
      {% csrf_token %}

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Make -->
        <div>
          <label for="id_make" class="block text-sm font-medium text-gray-700 mb-1">Make *</label>
          <input type="text" name="make" id="id_make"
                 value="{{ form.make.value|default_if_none:'' }}"
                 class="w-full rounded-lg border {% if form.make.errors %}border-red-500{% else %}border-gray-300{% endif %} px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-blue-600"
                 placeholder="e.g. Toyota" required />
          {% if form.make.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.make.errors.0 }}</p>
          {% endif %}
        </div>

        <!-- Model -->
        <div>
          <label for="id_model" class="block text-sm font-medium text-gray-700 mb-1">Model *</label>
          <input type="text" name="model" id="id_model"
                 value="{{ form.model.value|default_if_none:'' }}"
                 class="w-full rounded-lg border {% if form.model.errors %}border-red-500{% else %}border-gray-300{% endif %} px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-blue-600"
                 placeholder="e.g. Corolla" required />
          {% if form.model.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.model.errors.0 }}</p>
          {% endif %}
        </div>

        <!-- Year -->
        <div>
          <label for="id_year" class="block text-sm font-medium text-gray-700 mb-1">Year *</label>
          <input type="number" name="year" id="id_year" step="1"
                 value="{{ form.year.value|default_if_none:'' }}"
                 class="w-full rounded-lg border {% if form.year.errors %}border-red-500{% else %}border-gray-300{% endif %} px-4 py-3"
                 placeholder="e.g. 2018" required />
          {% if form.year.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.year.errors.0 }}</p>
          {% endif %}
        </div>

        <!-- Mileage -->
        <div>
          <label for="id_mileage" class="block text-sm font-medium text-gray-700 mb-1">Mileage (km)</label>
          <input type="number" name="mileage" id="id_mileage"
                 value="{{ form.mileage.value|default_if_none:'' }}"
                 class="w-full rounded-lg border {% if form.mileage.errors %}border-red-500{% else %}border-gray-300{% endif %} px-4 py-3"
                 placeholder="e.g. 85000" />
          {% if form.mileage.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.mileage.errors.0 }}</p>
          {% endif %}
        </div>

        <!-- Price -->
        <div>
          <label for="id_price" class="block text-sm font-medium text-gray-700 mb-1">Price (KES) *</label>
          <input type="number" name="price" id="id_price" step="0.01"
                 value="{{ form.price.value|default_if_none:'' }}"
                 class="w-full rounded-lg border {% if form.price.errors %}border-red-500{% else %}border-gray-300{% endif %} px-4 py-3"
                 placeholder="e.g. 1500000" required />
          {% if form.price.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.price.errors.0 }}</p>
          {% endif %}
        </div>

        <!-- Transmission -->
        <div>
          <label for="id_transmission" class="block text-sm font-medium text-gray-700 mb-1">Transmission</label>
          <select name="transmission" id="id_transmission"
                  class="w-full rounded-lg border {% if form.transmission.errors %}border-red-500{% else %}border-gray-300{% endif %} px-4 py-3">
            <option value="">Select</option>
            <option value="manual" {% if form.transmission.value == "manual" %}selected{% endif %}>Manual</option>
            <option value="automatic" {% if form.transmission.value == "automatic" %}selected{% endif %}>Automatic</option>
            <option value="cvt" {% if form.transmission.value == "cvt" %}selected{% endif %}>CVT</option>
          </select>
          {% if form.transmission.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.transmission.errors.0 }}</p>
          {% endif %}
        </div>

        <!-- Fuel Type -->
        <div>
          <label for="id_fuel_type" class="block text-sm font-medium text-gray-700 mb-1">Fuel Type</label>
          <select name="fuel_type" id="id_fuel_type"
                  class="w-full rounded-lg border {% if form.fuel_type.errors %}border-red-500{% else %}border-gray-300{% endif %} px-4 py-3">
            <option value="">Select</option>
            <option value="petrol" {% if form.fuel_type.value == "petrol" %}selected{% endif %}>Petrol</option>
            <option value="diesel" {% if form.fuel_type.value == "diesel" %}selected{% endif %}>Diesel</option>
            <option value="hybrid" {% if form.fuel_type.value == "hybrid" %}selected{% endif %}>Hybrid</option>
            <option value="electric" {% if form.fuel_type.value == "electric" %}selected{% endif %}>Electric</option>
            <option value="cng" {% if form.fuel_type.value == "cng" %}selected{% endif %}>CNG</option>
          </select>
          {% if form.fuel_type.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.fuel_type.errors.0 }}</p>
          {% endif %}
        </div>

        <!-- Color -->
        <div>
          <label for="id_color" class="block text-sm font-medium text-gray-700 mb-1">Color</label>
          <input type="text" name="color" id="id_color"
                 value="{{ form.color.value|default_if_none:'' }}"
                 class="w-full rounded-lg border {% if form.color.errors %}border-red-500{% else %}border-gray-300{% endif %} px-4 py-3"
                 placeholder="e.g. Silver" />
          {% if form.color.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.color.errors.0 }}</p>
          {% endif %}
        </div>

        <!-- Body Type -->
        <div>
          <label for="id_body_type" class="block text-sm font-medium text-gray-700 mb-1">Body Type</label>
          <select name="body_type" id="id_body_type"
                  class="w-full rounded-lg border {% if form.body_type.errors %}border-red-500{% else %}border-gray-300{% endif %} px-4 py-3">
            <option value="">Select</option>
            <option value="sedan" {% if form.body_type.value == "sedan" %}selected{% endif %}>Sedan</option>
            <option value="hatchback" {% if form.body_type.value == "hatchback" %}selected{% endif %}>Hatchback</option>
            <option value="suv" {% if form.body_type.value == "suv" %}selected{% endif %}>SUV</option>
            <option value="coupe" {% if form.body_type.value == "coupe" %}selected{% endif %}>Coupe</option>
            <option value="convertible" {% if form.body_type.value == "convertible" %}selected{% endif %}>Convertible</option>
            <option value="wagon" {% if form.body_type.value == "wagon" %}selected{% endif %}>Wagon</option>
            <option value="pickup" {% if form.body_type.value == "pickup" %}selected{% endif %}>Pickup Truck</option>
          </select>
          {% if form.body_type.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.body_type.errors.0 }}</p>
          {% endif %}
        </div>

        <!-- Engine Size -->
        <div>
          <label for="id_engine_size" class="block text-sm font-medium text-gray-700 mb-1">Engine Size (L)</label>
          <input type="number" name="engine_size" id="id_engine_size" step="0.1"
                 value="{{ form.engine_size.value|default_if_none:'' }}"
                 class="w-full rounded-lg border {% if form.engine_size.errors %}border-red-500{% else %}border-gray-300{% endif %} px-4 py-3"
                 placeholder="e.g. 2.0" />
          {% if form.engine_size.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.engine_size.errors.0 }}</p>
          {% endif %}
        </div>

        <!-- Doors -->
        <div>
          <label for="id_doors" class="block text-sm font-medium text-gray-700 mb-1">Doors</label>
          <input type="number" name="doors" id="id_doors"
                 value="{{ form.doors.value|default_if_none:'' }}"
                 class="w-full rounded-lg border {% if form.doors.errors %}border-red-500{% else %}border-gray-300{% endif %} px-4 py-3"
                 placeholder="e.g. 4" />
          {% if form.doors.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.doors.errors.0 }}</p>
          {% endif %}
        </div>

        <!-- Seats -->
        <div>
          <label for="id_seats" class="block text-sm font-medium text-gray-700 mb-1">Seats</label>
          <input type="number" name="seats" id="id_seats"
                 value="{{ form.seats.value|default_if_none:'' }}"
                 class="w-full rounded-lg border {% if form.seats.errors %}border-red-500{% else %}border-gray-300{% endif %} px-4 py-3"
                 placeholder="e.g. 5" />
          {% if form.seats.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.seats.errors.0 }}</p>
          {% endif %}
        </div>

        <!-- Condition -->
        <div>
          <label for="id_condition" class="block text-sm font-medium text-gray-700 mb-1">Condition</label>
          <select name="condition" id="id_condition"
                  class="w-full rounded-lg border {% if form.condition.errors %}border-red-500{% else %}border-gray-300{% endif %} px-4 py-3">
            <option value="">Select</option>
            <option value="New" {% if form.condition.value == "New" %}selected{% endif %}>New</option>
            <option value="Used" {% if form.condition.value == "Used" %}selected{% endif %}>Used</option>
            <option value="Certified Pre-Owned" {% if form.condition.value == "Certified Pre-Owned" %}selected{% endif %}>Certified Pre-Owned</option>
          </select>
          {% if form.condition.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.condition.errors.0 }}</p>
          {% endif %}
        </div>

        <!-- Status -->
        <div>
          <label for="id_status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
          <select name="status" id="id_status"
                  class="w-full rounded-lg border {% if form.status.errors %}border-red-500{% else %}border-gray-300{% endif %} px-4 py-3">
            <option value="available" {% if form.status.value == "available" %}selected{% endif %}>Available</option>
            <option value="sold" {% if form.status.value == "sold" %}selected{% endif %}>Sold</option>
            <option value="reserved" {% if form.status.value == "reserved" %}selected{% endif %}>Reserved</option>
          </select>
          {% if form.status.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.status.errors.0 }}</p>
          {% endif %}
        </div>

        <!-- Featured -->
        <div class="flex items-center space-x-3">
          <input type="checkbox" name="is_featured" id="id_is_featured" class="h-4 w-4 rounded border-gray-300"
                 {% if form.is_featured.value %}checked{% endif %}>
          <label for="id_is_featured" class="text-sm font-medium text-gray-700">Featured listing</label>
        </div>

      </div> <!-- end grid -->

      <!-- Description & Features (full width) -->
      <div>
        <label for="id_description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
        <textarea name="description" id="id_description" rows="4"
                  class="w-full rounded-lg border {% if form.description.errors %}border-red-500{% else %}border-gray-300{% endif %} px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-600">{{ form.description.value|default_if_none:'' }}</textarea>
        {% if form.description.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.description.errors.0 }}</p>
        {% endif %}
      </div>

      <div>
        <label for="id_features" class="block text-sm font-medium text-gray-700 mb-1">Key Features (comma separated)</label>
        <input type="text" name="features" id="id_features"
               value="{{ form.features.value|default_if_none:'' }}"
               class="w-full rounded-lg border {% if form.features.errors %}border-red-500{% else %}border-gray-300{% endif %} px-4 py-3"
               placeholder="e.g. AC,Power Steering,Alloy Wheels" />
        {% if form.features.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.features.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Images: multiple upload + preview -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Photos</label>
        <div class="flex items-center space-x-4">
          <input type="file" name="images" id="id_images" multiple accept="image/*"
                 class="block w-full text-sm text-gray-500 border border-gray-200 rounded-lg cursor-pointer bg-gray-50 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
        </div>

        <!-- Preview grid -->
        <div id="imagePreview" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3"></div>
      </div>

      <!-- Submit -->
      <div class="flex justify-end pt-6 border-t border-gray-200">
        <button type="submit" class="inline-flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-xl shadow-md hover:shadow-lg transition-all duration-200 ease-in-out">
          üíæ Save Car
        </button>
      </div>
    </form>
  </div>
</div>

<!-- small JS image preview -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const input = document.getElementById('id_images');
  const preview = document.getElementById('imagePreview');

  if (!input) return;

  input.addEventListener('change', function () {
    preview.innerHTML = '';
    const files = Array.from(this.files).slice(0, 8); // limit previews
    files.forEach(file => {
      if (!file.type.startsWith('image/')) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'relative rounded-lg overflow-hidden border border-gray-200';
        const img = document.createElement('img');
        img.src = e.target.result;
        img.className = 'object-cover w-full h-32';
        wrapper.appendChild(img);
        preview.appendChild(wrapper);
      };
      reader.readAsDataURL(file);
    });
  });
});
</script>
{% endblock %}
